# Job to register MLOps Monitor with Moltbook
apiVersion: batch/v1
kind: Job
metadata:
  name: register-mlops-monitor
  namespace: openclaw
  labels:
    app: openclaw
    agent: mlops-monitor
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: openclaw
        job: register-agent
    spec:
      restartPolicy: OnFailure
      containers:
      - name: register
        image: quay.io/openshift/origin-cli:latest
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 256Mi
            cpu: 200m
        command:
        - /bin/bash
        - -c
        - |
          set -e

          echo "Downloading jq..."
          curl -sL https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64 -o /tmp/jq
          chmod +x /tmp/jq

          MOLTBOOK_API="http://moltbook-api.moltbook.svc.cluster.local:3000"
          AGENT_NAME="mlops_monitor"
          SECRET_NAME="mlops-monitor-moltbook-key"

          # Check if rotation mode is enabled
          if [ "${ROTATE_KEY_ONLY:-false}" = "true" ]; then
            echo "üîÑ Rotating API key for ${AGENT_NAME}..."

            # Rotation requires admin key
            if [ -z "$ADMIN_API_KEY" ]; then
              echo "ERROR: ROTATE_KEY_ONLY=true but ADMIN_API_KEY not set"
              echo "Make sure adminbot-moltbook-key secret exists"
              exit 1
            fi

            # Call rotation endpoint
            RESPONSE=$(curl -s -X POST \
              "$MOLTBOOK_API/api/v1/admin/agents/${AGENT_NAME}/rotate-key" \
              -H "Authorization: Bearer $ADMIN_API_KEY" \
              -H "Content-Type: application/json")

            # Extract new API key
            API_KEY=$(echo "$RESPONSE" | /tmp/jq -r '.api_key')

            if [ "$API_KEY" = "null" ] || [ -z "$API_KEY" ]; then
              echo "ERROR: Failed to rotate API key"
              SAFE_RESPONSE=$(echo "$RESPONSE" | sed 's/"api_key":"[^"]*"/"api_key":"[REDACTED]"/g')
              echo "Response: $SAFE_RESPONSE"
              exit 1
            fi

            echo "‚úÖ Key rotated successfully! New key: ${API_KEY:0:20}..."
          else
            echo "üìù Registering ${AGENT_NAME} with Moltbook..."

            RESPONSE=$(curl -s -X POST \
              "$MOLTBOOK_API/api/v1/agents/register" \
              -H "Content-Type: application/json" \
              -d @/agent/agent.json)

            # Extract API key from response
            API_KEY=$(echo "$RESPONSE" | /tmp/jq -r '.agent.api_key')

            if [ "$API_KEY" = "null" ] || [ -z "$API_KEY" ]; then
              echo "ERROR: Failed to get API key from response"
              # Redact credentials before logging
              SAFE_RESPONSE=$(echo "$RESPONSE" | sed 's/"api_key":"[^"]*"/"api_key":"[REDACTED]"/g' | sed 's/moltbook_[A-Za-z0-9_-]*/[REDACTED]/g')
              echo "Full response: $SAFE_RESPONSE"
              exit 1
            fi

            echo "‚úÖ Successfully registered! API Key: ${API_KEY:0:20}..."
          fi

          # Create/update secret (same for both registration and rotation)
          echo "Updating Kubernetes secret..."
          oc create secret generic "$SECRET_NAME" \
            -n openclaw \
            --from-literal=api_key="$API_KEY" \
            --dry-run=client -o yaml | oc apply -f -

          echo "‚úÖ Secret ${SECRET_NAME} updated!"
          echo "${AGENT_NAME} setup complete!"
        env:
        - name: ROTATE_KEY_ONLY
          value: "false"  # Set to "true" to rotate instead of register
        - name: ADMIN_API_KEY
          valueFrom:
            secretKeyRef:
              name: audit-reporter-moltbook-key
              key: api_key
              optional: true  # Only required for rotation
        volumeMounts:
        - name: agent-config
          mountPath: /agent
      volumes:
      - name: agent-config
        configMap:
          name: mlops-monitor-agent
      serviceAccountName: openclaw-agent-manager
